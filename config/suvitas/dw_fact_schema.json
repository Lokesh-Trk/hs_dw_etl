{
	"database": "healthscore_dw",

	"insert_table_info": [
		{
			"tablename": "fact_patient_visits",
			"source_table": "hs_patient_visit_details",
			"fields": "patient_key,visit_hospital_key,visit_date_key,visit_time_key ,visit_doctor_staff_key ,hospital_patient_visit_id,checkin_ts,checkout_ts,checkout_type,delivery_ts,outcome_type,condition_at_discharge,discharge_ts,visit_type,visit_reason ,visit_rate_category_nm,visit_ip_nbr ,admission_method ,cancel_reason,ward_nm,referral_source,source_cd,created_by_staff_key,patient_visit_cd,etl_load_id",
			"insert_query": "SELECT  p.patient_key, p.hospital_key, DATE(pvd.checkin_ts) AS visit_date_key, TIME(pvd.checkin_ts) AS visit_time_key, ds.staff_key as visit_doctor_staff_key, pvd.patient_visit_id, pvd.checkin_ts, pvd.checkout_ts, pvd.checkout_type, pvd.delivery_ts, pvd.outcome_type, pvd.condition_at_discharge, pvd.discharge_ts, pvd.visit_type, pvd.visit_reason, rcm.rate_category_nm, pvd.ip_nbr, pvd.admission_method, pvd.cancel_reason, w.hospital_ward_nm,pvd.referral_source,'{0}', ds_cb.staff_key,pvd.patient_visit_cd,{1} FROM healthscore_stg.hs_patient_visit_details pvd JOIN healthscore_stg.hs_patient_master hpm ON hpm.patient_id = pvd.patient_id AND hpm.primary_hospital_id = pvd.hospital_id JOIN healthscore_stg.hs_hospital_master hm ON hpm.primary_hospital_id = hm.hospital_id JOIN healthscore_dw.map_patient_hospital p ON hpm.patient_cd = p.hospital_patient_cd and p.hospital_cd=hm.hs_hospital_cd_guid  JOIN healthscore_stg.hs_rate_category_master rcm ON pvd.visit_rate_category_id = rcm.rate_category_master_id JOIN healthscore_dw.dim_staff ds_cb ON ds_cb.hospital_staff_user_nm = pvd.created_by and ds_cb.hospital_key=p.hospital_key left JOIN healthscore_dw.dim_staff ds ON ds.hospital_staff_id = pvd.doctor_id and ds.hospital_key=p.hospital_key LEFT JOIN healthscore_dw.dim_hospital_wards AS w ON pvd.ward_id = w.hospital_ward_id AND p.hospital_key = w.hospital_key",
			"where_clause": "p.hospital_key=%i",
			"update_fields": "visit_type=src.visit_type"
		},

		{
			"tablename": "map_patient_visit_doctors",
			"source_table": "hs_patient_visit_doctors",
			"fields": "patient_key,visit_hospital_key,patient_visit_key,visit_doctor_staff_key,hospital_visit_doctor_id,hospital_patient_visit_id,patient_visit_doctor_ts,source_cd,etl_load_id",
			"insert_query": "SELECT pv.patient_key, pv.visit_hospital_key, pv.patient_visit_key, ds.staff_key AS visit_doctor_staff_key, pvd.visit_doctor_id AS hospital_visit_doctor_id, pvd.patient_visit_id AS hospital_patient_visit_id, pvd.created_ts AS patient_visit_doctor_ts,'{0}',{1} FROM healthscore_stg.hs_patient_visit_doctors pvd   JOIN healthscore_dw.fact_patient_visits pv on pv.hospital_patient_visit_id=pvd.patient_visit_id and source_cd='{0}' JOIN healthscore_dw.map_patient_hospital mph on mph.hospital_key=pv.visit_hospital_key and mph.patient_key=pv.patient_key   JOIN healthscore_stg.hs_hospital_master hm on hm.hs_hospital_cd_guid=mph.hospital_cd JOIN healthscore_dw.dim_staff ds ON ds.hospital_key = pv.visit_hospital_key AND ds.hospital_staff_id = pvd.hospital_staff_id",
			"where_clause": "mph.hospital_key=%i",
			"update_fields": ""
		},
		{
			"tablename": "fact_patient_vitals",
			"source_table": "hs_patient_visit_vitals",
			"fields": "patient_key,vital_ref_component_id,vital_ref_display_txt,measurementunit_ref_component_id,measurementunit_ref_display_txt,patient_vital_value,vital_recorded_date_key,vital_recorded_time_key,vital_recorded_ts,biomedicaldevice_ref_id,recorded_hospital_key,recorded_patient_visit_key,vital_created_ts,created_by_staff_key,source_cd,etl_load_id",
			"insert_query": "select pv.patient_key, vm.vital_ref_component_id,vm.vital_ref_display_txt,vm.measurementunit_ref_component_id,vm.measurementunit_ref_display_txt,vv.patient_vital_value,date(vv.vital_recorded_ts) as vital_recorded_date_key,time(vv.vital_recorded_ts) as vital_recorded_time_key,vv.vital_recorded_ts,vv.biomedicaldevice_ref_id, pv.visit_hospital_key, pv.patient_visit_key, vv.created_ts,ds.staff_key,'{0}',{1} from healthscore_stg.hs_patient_visit_vitals vv join healthscore_stg.hs_ref_vitals_master vm on vv.vital_ref_id = vm.vital_ref_component_id join healthscore_stg.hs_patient_master hpm on hpm.patient_id=vv.patient_id join healthscore_stg.hs_hospital_master hm on hpm.primary_hospital_id=hm.hospital_id join healthscore_dw.map_patient_hospital p on hpm.patient_cd= p.hospital_patient_cd and hm.hs_hospital_cd_guid=p.hospital_cd join healthscore_dw.fact_patient_visits pv on pv.patient_key=p.patient_key and pv.visit_hospital_key=p.hospital_key and pv.hospital_patient_visit_id=vv.created_patient_visit_id join healthscore_dw.dim_staff ds on ds.hospital_staff_user_nm=vv.created_by and ds.hospital_key=p.hospital_key",
			"where_clause": "pv.visit_hospital_key=%i",
			"update_fields": "patient_vital_value=src.patient_vital_value"
		},
		{
			"tablename": "fact_patient_visitbills",
			"source_table": "hs_patient_visit_bill",
			"fields": "patient_key,visit_hospital_key,patient_visit_key,visit_bill_id,visit_bill_cd, visit_bill_total_amt,visit_bill_paid_amt,visit_bill_concession_amt,visit_bill_waived_amt,visit_bill_refund_amt,visit_bill_balance_amt,visit_bill_from_ts,visit_bill_to_ts,visit_bill_comments,visit_bill_adjusted_flg,visit_bill_created_ts,visit_bill_date_key,visit_bill_time_key,visit_billed_ts,created_by_staff_key,modified_by_staff_key,source_cd,etl_load_id",
			"insert_query": "SELECT fpv.patient_key, fpv.visit_hospital_key, fpv.patient_visit_key,pvb.visit_bill_id, pvb.visit_bill_cd, pvb.bill_total_amt AS visit_bill_total_amt, pvb.bill_paid_amt AS visit_bill_paid_amt, pvb.bill_concession_amt AS visit_bill_concession_amt, pvb.waived_amt AS visit_bill_waived_amt, pvb.bill_refund_amt AS visit_bill_refund_amt,pvb.bill_balance_amt AS visit_bill_balance_amt,pvb.bill_from_ts, pvb.bill_to_ts, pvb.bill_comments AS visit_bill_comments, pvb.adjusted_flg AS visit_bill_adjusted_flg, pvb.created_ts as visit_bill_created_ts,DATE(pvb.created_ts) as visit_bill_date_key,TIME(pvb.created_ts) as visit_bill_time_key, pvb.billed_ts as visit_billed_ts, ds_c.staff_key AS created_by_staff_key, ds_m.staff_key AS modified_by_staff_key,'{0}',{1} FROM healthscore_stg.hs_patient_visit_bill pvb JOIN healthscore_dw.fact_patient_visits fpv ON fpv.hospital_patient_visit_id = pvb.patient_visit_id and source_cd='{0}' join healthscore_dw.map_patient_hospital mp on mp.hospital_key = fpv.visit_hospital_key and mp.patient_key=fpv.patient_key left JOIN healthscore_dw.dim_staff ds_c ON ds_c.hospital_key = fpv.visit_hospital_key AND ds_c.hospital_staff_user_nm = pvb.created_by LEFT JOIN healthscore_dw.dim_staff ds_m ON ds_m.hospital_key = fpv.visit_hospital_key AND ds_m.hospital_staff_user_nm = pvb.modified_by",
			"where_clause": "fpv.visit_hospital_key=%i",
			"update_fields": "visit_bill_total_amt=src.visit_bill_total_amt,visit_bill_paid_amt=src.visit_bill_paid_amt,visit_bill_concession_amt=src.visit_bill_concession_amt,visit_bill_waived_amt=src.visit_bill_waived_amt,visit_bill_refund_amt=src.visit_bill_refund_amt,visit_bill_comments=src.visit_bill_comments,visit_billed_ts=src.visit_billed_ts,visit_bill_adjusted_flg=src.visit_bill_adjusted_flg,modified_by_staff_key =src.modified_by_staff_key"
		},
		{
			"tablename": "fact_patient_medications",
			"source_table": "hs_patient_medication_details",
			"fields": "patient_key, pharma_product_ref_id, pharma_product_ref_display_txt , pharma_brand_nm, dosage, drug_form_ref_id , drug_form_ref_display_txt, frequency, comments, start_dt, end_dt, active_flg,prescribed_doctor_staff_key, prescribed_hospital_key, prescribed_ts, prescribed_patient_visit_key,created_by_staff_key,prescribed_date_key,prescribed_time_key,etl_load_id",
			"insert_query": "SELECT  pvd.patient_key, pmd.pharma_product_ref_id, pmd.pharma_product_ref_display_txt, pmd.pharma_brand_name, pmd.dosage, pmd.drug_form_ref_id, pmd.drug_form_ref_display_txt, pmd.frequency, pmd.comments, pmd.start_dt, pmd.end_dt, pmd.active_flg,  pvd.visit_doctor_staff_key, pvd.visit_hospital_key, pmd.created_ts, pvd.patient_visit_key, ds.staff_key, DATE(pmd.created_ts), TIME(pmd.created_ts),{1} FROM healthscore_stg.hs_patient_medication_details pmd JOIN healthscore_stg.hs_patient_master pm ON pm.patient_id = pmd.patient_id JOIN healthscore_dw.map_patient_visit_doctors pvd ON pvd.hospital_visit_doctor_id = pmd.created_patient_visit_doctor_id and source_cd='{0}' JOIN healthscore_dw.dim_staff ds ON ds.hospital_staff_user_nm = pmd.created_by AND ds.hospital_key = pvd.visit_hospital_key",
			"where_clause": "pvd.visit_hospital_key=%i",
			"update_fields": "pharma_product_ref_id=src.pharma_product_ref_id, pharma_product_ref_display_txt=src.pharma_product_ref_display_txt,dosage=src.dosage,frequency=src.frequency, comments=src.comments, start_dt=src.start_dt, end_dt=src.end_dt,active_flg=src.active_flg"
		},
		{
			"tablename": "fact_patient_clinical_info",
			"source_table": "hs_patient_allergy_details",
			"fields": "patient_key,patient_visit_key,created_staff_key,clinical_info_type_cd,clinical_info_ref_id,clinical_info_desc,effective_from_ts,effective_to_ts,recorded_date_key,recorded_time_key,etl_load_id",
			"insert_query": "select map_p.patient_key, fpv.patient_visit_key,dim_s.staff_key, 'allergy',allergy_ref_id as clinical_info_ref_id,allergy_ref_display_txt as clinical_info_desc,pad.created_ts as effective_from_ts,case when pad.active_flg =0 then pad.modified_ts else null end as effective_to_ts, date(pad.created_ts),time(pad.created_ts),{1} from healthscore_stg.hs_patient_allergy_details pad join healthscore_stg.hs_patient_master pm on pm.patient_id = pad.patient_id join healthscore_stg.hs_hospital_master hm on hm.hospital_id =  pm.primary_hospital_id join healthscore_dw.map_patient_hospital map_p on map_p.hospital_patient_id = pad.patient_id and map_p.hospital_cd = hm.hs_hospital_cd_guid LEFT JOIN healthscore_dw.fact_patient_visits fpv on pad.created_patient_visit_id = fpv.hospital_patient_visit_id and map_p.hospital_key = fpv.visit_hospital_key LEFT JOIN healthscore_dw.dim_staff dim_s ON dim_s.hospital_key = map_p.hospital_key AND dim_s.hospital_staff_user_nm = pad.created_by",
			"where_clause": "fpv.visit_hospital_key=%i",
			"update_fields": "clinical_info_ref_id=src.clinical_info_ref_id,clinical_info_desc=src.clinical_info_desc,effective_from_ts=src.effective_from_ts,effective_to_ts=src.effective_from_ts"
		},
		{
			"tablename": "fact_patient_clinical_info",
			"source_table": "hs_patient_family_history_details",
			"fields": "patient_key,patient_visit_key,created_staff_key,clinical_info_type_cd,clinical_info_ref_id,clinical_info_desc,effective_from_ts,effective_to_ts,recorded_date_key,recorded_time_key,etl_load_id",
			"insert_query": "SELECT  mph.patient_key, CASE WHEN fhd.created_patient_visit_id IS NULL THEN NULL ELSE fpv.patient_visit_key END, ds.staff_key, 'familyhistory', fhd.family_history_ref_id as clinical_info_ref_id, fhd.family_history_ref_display_txt as clinical_info_desc, fhd.created_ts as effective_from_ts, CASE WHEN fhd.active_flg = 0 THEN fhd.modified_ts ELSE NULL END AS effective_to_ts,date(fhd.created_ts), time(fhd.created_ts),{1} FROM healthscore_stg.hs_patient_family_history_details fhd JOIN healthscore_stg.hs_patient_master hpm ON hpm.patient_id = fhd.patient_id JOIN healthscore_stg.hs_hospital_master hhm ON hhm.hospital_id = hpm.primary_hospital_id JOIN healthscore_dw.map_patient_hospital mph ON mph.hospital_patient_cd = hpm.patient_cd AND mph.hospital_cd = hhm.hs_hospital_cd_guid LEFT JOIN healthscore_dw.dim_staff ds ON ds.hospital_staff_user_nm = fhd.created_by AND ds.hospital_key = mph.hospital_key LEFT JOIN healthscore_dw.fact_patient_visits fpv ON fpv.patient_key = mph.patient_key AND fpv.visit_hospital_key = mph.hospital_key AND fpv.hospital_patient_visit_id = fhd.created_patient_visit_id",
			"where_clause": "fpv.visit_hospital_key=%i",
			"update_fields": "clinical_info_ref_id=src.clinical_info_ref_id,clinical_info_desc=src.clinical_info_desc,effective_from_ts=src.effective_from_ts,effective_to_ts=src.effective_from_ts"
		},
		{
			"tablename": "fact_patient_clinical_info",
			"source_table": "hs_patient_past_history_details",
			"fields": "patient_key,patient_visit_key,created_staff_key,clinical_info_type_cd,clinical_info_ref_id,clinical_info_desc,effective_from_ts,effective_to_ts,recorded_date_key,recorded_time_key,etl_load_id",
			"insert_query": "SELECT  mph.patient_key, case when pphd.created_patient_visit_id is null then null else fpv.patient_visit_key end, ds.staff_key, 'pasthistory', pphd.past_history_ref_id as clinical_info_ref_id, pphd.past_history_ref_display_txt as clinical_info_desc, pphd.created_ts as effective_from_ts, CASE WHEN pphd.active_flg = 0 THEN pphd.modified_ts ELSE NULL END AS effective_to_ts,date(pphd.created_ts), time(pphd.created_ts),{1} FROM healthscore_stg.hs_patient_past_history_details pphd JOIN  healthscore_stg.hs_patient_master hpm on hpm.patient_id=pphd.patient_id JOIN  healthscore_stg.hs_hospital_master hhm on hhm.hospital_id=hpm.primary_hospital_id JOIN  healthscore_dw.map_patient_hospital mph on mph.hospital_patient_cd=hpm.patient_cd and mph.hospital_cd=hhm.hs_hospital_cd_guid left JOIN healthscore_dw.dim_staff ds on ds.hospital_staff_user_nm=pphd.created_by and ds.hospital_key=mph.hospital_key left JOIN  healthscore_dw.fact_patient_visits fpv on fpv.patient_key=mph.patient_key and fpv.visit_hospital_key=mph.hospital_key and fpv.hospital_patient_visit_id=pphd.created_patient_visit_id",
			"where_clause": "fpv.visit_hospital_key=%i",
			"update_fields": "clinical_info_ref_id=src.clinical_info_ref_id,clinical_info_desc=src.clinical_info_desc,effective_from_ts=src.effective_from_ts,effective_to_ts=src.effective_from_ts"
		},
		{
			"tablename": "fact_patient_visitbillitems",
			"source_table": "hs_patient_visit_bill_items",
			"fields": "patient_visitbill_key,bill_item_key,bill_item_qty, bill_item_unit_amt,bill_item_total_concession_amt,bill_item_final_amt, bill_item_receipt_cd,active_flg,pharmacy_item_flg,vbi_created_ts,vbi_date_key,vbi_time_key,payment_method_id,bill_item_total_tax,bill_item_returned_qty,vbi_created_staff_key,vbi_modified_staff_key,etl_load_id",
			"insert_query": "SELECT fpvb.patient_visitbill_key, dbi.bill_item_key, pvbi.bill_item_qty AS bill_item_qty, pvbi.bill_item_unit_amt AS bill_item_unit_amt, pvbi.bill_item_total_concession_amt AS bill_item_total_concession_amt, pvbi.bill_item_final_amt AS bill_item_final_amt, pvbi.bill_item_receipt_cd AS bill_item_receipt_cd, pvbi.active_flg, pvbi.pharmacy_item, pvbi.created_ts,Date(pvbi.created_ts),Time(pvbi.created_ts), pvbi.payment_method_id, pvbi.bill_item_total_tax, pvbi.returned_qty, ds_c.staff_key, ds_m.staff_key AS vbi_modified_staff_key,{1} FROM healthscore_stg.hs_patient_visit_bill_items pvbi JOIN healthscore_dw.fact_patient_visitbills fpvb ON pvbi.visit_bill_id = fpvb.visit_bill_id AND source_cd = '{0}'  JOIN healthscore_dw.dim_bill_items dbi ON dbi.bill_item_id = pvbi.bill_item_id AND dbi.bill_item_type = 'bill_item' AND dbi.hospital_key = fpvb.visit_hospital_key JOIN     healthscore_dw.dim_staff ds_c ON ds_c.hospital_key = fpvb.visit_hospital_key AND ds_c.hospital_staff_user_nm = pvbi.created_by  LEFT JOIN     healthscore_dw.dim_staff ds_m ON ds_m.hospital_key = fpvb.visit_hospital_key AND ds_m.hospital_staff_user_nm = pvbi.modified_by",
			"where_clause": "fpvb.visit_hospital_key=%i",
			"update_fields": "bill_item_qty=src.bill_item_qty,bill_item_unit_amt=src.bill_item_unit_amt,bill_item_total_concession_amt=src.bill_item_total_concession_amt,bill_item_final_amt=src.bill_item_final_amt, bill_item_receipt_cd=src.bill_item_receipt_cd,active_flg=src.active_flg,pharmacy_item_flg=src.pharmacy_item,payment_method_id=src.payment_method_id,bill_item_returned_qty=src.returned_qty,vbi_modified_staff_key=src.vbi_modified_staff_key"
		},
		{
			"tablename": "fact_patient_visitbillitems",
			"source_table": "hs_patient_visit_bill_items-consultation",
			"fields": "patient_visitbill_key,bill_item_key,bill_item_qty, bill_item_unit_amt,bill_item_total_concession_amt,bill_item_final_amt, bill_item_receipt_cd,active_flg,pharmacy_item_flg,vbi_created_ts,vbi_date_key,vbi_time_key,payment_method_id,bill_item_total_tax,bill_item_returned_qty,vbi_created_staff_key,vbi_modified_staff_key,etl_load_id",
			"insert_query": "SELECT fpvb.patient_visitbill_key, dbi_con.bill_item_key,pvbi.bill_item_qty,  pvbi.bill_item_unit_amt,  pvbi.bill_item_total_concession_amt ,  pvbi.bill_item_final_amt ,  pvbi.bill_item_receipt_cd,  pvbi.active_flg,  pvbi.pharmacy_item,  pvbi.created_ts,date(pvbi.created_ts), time(pvbi.created_ts),  pvbi.payment_method_id,  pvbi.bill_item_total_tax,  pvbi.returned_qty,  ds_c.staff_key,  ds_m.staff_key AS vbi_modified_staff_key,{1} FROM  healthscore_stg.hs_patient_visit_bill_items pvbi  JOIN  healthscore_dw.fact_patient_visitbills fpvb ON pvbi.visit_bill_id = fpvb.visit_bill_id  JOIN healthscore_dw.dim_bill_items dbi_con ON dbi_con.bill_item_id=pvbi.con_charge_id and dbi_con.bill_item_type='consultation'   AND dbi_con.hospital_key = fpvb.visit_hospital_key  JOIN  healthscore_dw.dim_staff ds_c ON ds_c.hospital_key = fpvb.visit_hospital_key  AND ds_c.hospital_staff_user_nm = pvbi.created_by  left join   healthscore_dw.dim_staff ds_m ON ds_m.hospital_key = fpvb.visit_hospital_key  AND ds_m.hospital_staff_user_nm = pvbi.modified_by",
			"where_clause": "fpvb.visit_hospital_key=%i",
			"update_fields": "bill_item_qty=src.bill_item_qty,bill_item_unit_amt=src.bill_item_unit_amt,bill_item_total_concession_amt=src.bill_item_total_concession_amt,bill_item_final_amt=src.bill_item_final_amt,bill_item_receipt_cd=src.bill_item_receipt_cd,active_flg=src.active_flg,pharmacy_item_flg=src.pharmacy_item,payment_method_id=src.payment_method_id,bill_item_returned_qty=src.returned_qty,vbi_modified_staff_key=src.vbi_modified_staff_key"
		},
		{
			"tablename": "fact_patient_visitbillitems",
			"source_table": "hs_patient_visit_bill_items-payment",
			"fields": "patient_visitbill_key,bill_item_key,bill_item_qty, bill_item_unit_amt,bill_item_total_concession_amt,bill_item_final_amt, bill_item_receipt_cd,active_flg,pharmacy_item_flg,vbi_created_ts,vbi_date_key,vbi_time_key,payment_method_id,bill_item_total_tax,bill_item_returned_qty,vbi_created_staff_key,vbi_modified_staff_key,etl_load_id",
			"insert_query": "SELECT fpvb.patient_visitbill_key,dbi.bill_item_key, pvbi.bill_item_qty, pvbi.bill_item_unit_amt, pvbi.bill_item_total_concession_amt, pvbi.bill_item_final_amt, pvbi.bill_item_receipt_cd, pvbi.active_flg, pvbi.pharmacy_item, pvbi.created_ts,date(pvbi.created_ts),time(pvbi.created_ts), pvbi.payment_method_id, pvbi.bill_item_total_tax, pvbi.returned_qty, ds_c.staff_key, ds_m.staff_key AS vbi_modified_staff_key,{1} FROM healthscore_stg.hs_patient_visit_bill_items pvbi JOIN healthscore_dw.fact_patient_visitbills fpvb ON pvbi.visit_bill_id = fpvb.visit_bill_id JOIN healthscore_dw.dim_bill_items dbi ON dbi.bill_item_id = pvbi.bill_item_id and dbi.bill_item_type='bill_payment'  AND dbi.hospital_key = fpvb.visit_hospital_key JOIN healthscore_dw.dim_staff ds_c ON ds_c.hospital_key = fpvb.visit_hospital_key AND ds_c.hospital_staff_user_nm = pvbi.created_by left join  healthscore_dw.dim_staff ds_m ON ds_m.hospital_key = fpvb.visit_hospital_key AND ds_m.hospital_staff_user_nm = pvbi.modified_by",
			"where_clause": "fpvb.visit_hospital_key=%i",
			"update_fields": "bill_item_qty=src.bill_item_qty,bill_item_unit_amt=src.bill_item_unit_amt,bill_item_total_concession_amt=src.bill_item_total_concession_amt,bill_item_final_amt=src.bill_item_final_amt, bill_item_receipt_cd=src.bill_item_receipt_cd,active_flg=src.active_flg,pharmacy_item_flg=src.pharmacy_item,payment_method_id=src.payment_method_id,bill_item_returned_qty=src.returned_qty,vbi_modified_staff_key=src.vbi_modified_staff_key"
		},
		{
			"tablename": "fact_patient_visitbillitems",
			"source_table": "hs_patient_visit_bill_items-package",
			"fields": "patient_visitbill_key,bill_item_key,bill_item_qty, bill_item_unit_amt,bill_item_total_concession_amt,bill_item_final_amt, bill_item_receipt_cd,active_flg,pharmacy_item_flg,vbi_created_ts,vbi_date_key,vbi_time_key,payment_method_id,bill_item_total_tax,bill_item_returned_qty,vbi_created_staff_key,vbi_modified_staff_key,etl_load_id",
			"insert_query": "SELECT fpvb.patient_visitbill_key,dbi_pkg.bill_item_key, pvbi.bill_item_qty,  pvbi.bill_item_unit_amt,  pvbi.bill_item_total_concession_amt,  pvbi.bill_item_final_amt, pvbi.bill_item_receipt_cd,  pvbi.active_flg,  pvbi.pharmacy_item,  pvbi.created_ts, date(pvbi.created_ts),time(pvbi.created_ts),  pvbi.payment_method_id,  pvbi.bill_item_total_tax,  pvbi.returned_qty,  ds_c.staff_key,  ds_m.staff_key AS vbi_modified_staff_key,{1} FROM  healthscore_stg.hs_patient_visit_bill_items pvbi  JOIN  healthscore_dw.fact_patient_visitbills fpvb ON pvbi.visit_bill_id = fpvb.visit_bill_id  join (Select distinct(bill_item_category_id) as bill_item_category_id,bill_item_category_cd as bill_item_cd ,bill_item_key,bill_item_type from healthscore_dw.dim_bill_items where bill_item_type='bill_package' )dbi_pkg on dbi_pkg.bill_item_category_id=pvbi.bill_item_id   JOIN  healthscore_dw.dim_staff ds_c ON ds_c.hospital_key = fpvb.visit_hospital_key  AND ds_c.hospital_staff_user_nm = pvbi.created_by  left join   healthscore_dw.dim_staff ds_m ON ds_m.hospital_key = fpvb.visit_hospital_key  AND ds_m.hospital_staff_user_nm = pvbi.modified_by",
			"where_clause": "fpvb.visit_hospital_key=%i",
			"update_fields": "bill_item_qty=src.bill_item_qty,bill_item_unit_amt=src.bill_item_unit_amt,bill_item_total_concession_amt=src.bill_item_total_concession_amt,bill_item_final_amt=src.bill_item_final_amt, bill_item_receipt_cd=src.bill_item_receipt_cd,active_flg=src.active_flg,pharmacy_item_flg=src.pharmacy_item,payment_method_id=src.payment_method_id,bill_item_returned_qty=src.returned_qty,vbi_modified_staff_key=src.vbi_modified_staff_key"
		},
		{
			"tablename": "fact_patient_visit_advice",
			"source_table": "hs_patient_visit_actions-advice",
			"fields": "patient_key ,  visit_doctor_staff_key , visit_hospital_key ,advice_desc, active_flg, note_created_ts ,  note_modified_ts , created_by_staff_key,  modified_by_staff_key,etl_load_id",
			"insert_query": "SELECT patient_key,  visit_doctor_staff_key, visit_hospital_key,action_desc as advice_desc, pva.active_flg,pva.created_ts as note_created_ts ,pva.modified_ts as note_modified_ts,ds_c.staff_key,ds_m.staff_key as modified_by_staff_key,{1} FROM healthscore_stg.hs_patient_visit_actions pva join healthscore_dw.map_patient_visit_doctors mpv on mpv.hospital_visit_doctor_id = pva.visit_doctor_id join healthscore_dw.dim_staff ds_c on ds_c.hospital_staff_user_nm=pva.created_by and ds_c.hospital_key=visit_hospital_key left join healthscore_dw.dim_staff ds_m on ds_m.hospital_staff_user_nm=pva.created_by and ds_m.hospital_key=visit_hospital_key",
			"where_clause": "visit_hospital_key=%i and pva.action_category_ref_component_id = 418043000",
			"update_fields": "advice_desc=src.advice_desc, active_flg=src.active_flg,note_modified_ts=src.note_modified_ts, modified_by_staff_key=src.modified_by_staff_key"
		},
		{
			"tablename": "fact_active_visits",
			"source_table": "hs_patient_visit_details",
			"fields": "as_of_date_key,patient_visit_key,patient_key,hospital_key,visit_date_key,patient_visitbill_key,bill_item_key,daily_rate,daily_rate_updated_by,billed_days,ward_nm,referred_by,primary_hospital_nm,admitted_days,total_paid_amt,total_refund_amt,total_waived_amt,total_billed_amt,current_balance_amt,etl_load_id",
			"insert_query": "SELECT a.as_of_date_key,a.patient_visit_key,a.patient_key,a.hospital_key,a.visit_date_key,a.patient_visitbill_key,a.bill_item_key,a.daily_rate,a.daily_rate_updated_by,a.billied_days,a.ward_nm,a.referred_by,a.primary_hospital_nm,a.admitted_days,a.total_paid_amt,a.total_refund_amt,a.total_waived_amt,a.total_billed_amt,a.current_balance_amt,{1} FROM (SELECT TIMESTAMPADD(HOUR,-5,CURRENT_TIMESTAMP) AS as_of_date_key,fpv.patient_visit_key,fpv.patient_key, fpv.visit_hospital_key AS hospital_key, fpv.visit_date_key,fpvb.patient_visitbill_key,dbi.bill_item_key as bill_item_key,hpvs.daily_rate,hpvs.daily_rate_modified_by AS daily_rate_updated_by,hpvs.billied_days,fpv.ward_nm,hpvs.referral_source AS referred_by,ehd.external_hospital_nm AS primary_hospital_nm,DATEDIFF(IFNULL(date(fpv.checkout_ts),date(CURRENT_TIMESTAMP)),date(fpv.checkin_ts)) AS admitted_days,SUM(CASE WHEN pvbi.bill_item_cd = 'PYR' THEN pvbi.bill_item_final_amt ELSE 0 END) AS total_paid_amt,SUM(CASE WHEN pvbi.bill_item_cd = 'PRF' THEN pvbi.bill_item_final_amt ELSE 0 END) AS total_refund_amt,SUM(CASE WHEN pvbi.bill_item_cd = 'WAI' THEN pvbi.bill_item_final_amt ELSE 0 END) AS total_waived_amt,SUM(CASE WHEN pvbi.bill_item_cd NOT IN ('PYR' ,'PYO','PRF','WAI') THEN pvbi.bill_item_final_amt ELSE 0 END) AS total_billed_amt,SUM(CASE WHEN dbi.bill_item_cd = 'PYO' THEN pvbi.bill_item_final_amt ELSE 0 END) AS current_balance_amt FROM   healthscore_dw.fact_patient_visits fpv JOIN healthscore_dw.fact_patient_visitbills fpvb ON fpv.patient_visit_key=fpvb.patient_visit_key JOIN healthscore_stg.hs_patient_visit_details hpvs ON hpvs.patient_visit_id=fpv.hospital_patient_visit_id JOIN healthscore_stg.hs_patient_visit_bill hpvb ON hpvb.patient_visit_id = hpvs.patient_visit_id AND fpvb.visit_bill_id=hpvb.visit_bill_id JOIN healthscore_stg.hs_patient_visit_bill_items pvbi ON pvbi.visit_bill_id = hpvb.visit_bill_id JOIN healthscore_dw.dim_bill_items dbi ON dbi.bill_item_id=pvbi.bill_item_id LEFT JOIN healthscore_stg.hs_ext_hospital_doctors_master ehd ON hpvs.primary_doctor_id=ehd.doctor_id WHERE fpv.checkout_ts IS NULL OR (date(fpv.checkout_ts)=date(current_timestamp)) GROUP BY pvbi.visit_bill_id) a UNION ALL SELECT prev_date.as_of_date_key,fpv.patient_visit_key,fpv.patient_key,fpv.hospital_key,fpv.visit_date_key,fpv.patient_visitbill_key,fpv.bill_item_key,fpv.daily_rate,fpv.daily_rate_updated_by,fpv.billed_days,fpv.ward_nm,fpv.referred_by,fpv.primary_hospital_nm,fpv.admitted_days,fpv.total_paid_amt,fpv.total_refund_amt,fpv.total_waived_amt,fpv.total_billed_Amt,fpv.current_balance_amt,{1} FROM healthscore_dw.fact_active_visits fpv CROSS JOIN ( SELECT ADDDATE(MAX(a.as_of_date_key), INTERVAL @i:=@i+1 DAY) AS as_of_date_key FROM (SELECT @i:=0) a JOIN healthscore_dw.fact_active_visits a GROUP BY a.as_of_date_key HAVING @i < DATEDIFF(CURRENT_TIMESTAMP,MAX(a.as_of_date_key))-1)  as prev_date",
			"where_clause": "hospital_key=%i",
			"update_fields": ""
		},
		{
			"tablename": "fact_patient_assessments",
			"source_table": "hs_patient_assessment",
			"fields": "patient_key,visit_hospital_key,patient_visit_key,health_assessment_scale_desc,hospital_dept_nm,assessment_result_item_seq_no,assessment_result_item_ref_range_txt,assessment_result_item_display_txt,assessment_result_item_value,assessed_date_key  ,assessed_time_key,assessed_ts ,etl_load_id",
			"insert_query": "select mph.patient_key,mph.hospital_key,fpv.patient_visit_key,asm.health_assessment_scale_desc,dept.dept_name,asr.sequence_no,asr.component_reference_range_txt,asr.ref_display_txt,par.assessment_scale_result_value, date(pas.assessed_ts),time(pas.assessed_ts),pas.assessed_ts,{1} from healthscore_stg.hs_patient_assessment pas join healthscore_stg.hs_patient_assessment_scale_results par on pas.hs_patient_assessment_id=par.hs_patient_assessment_id join healthscore_stg.hs_health_assessment_scale_master asm on asm.health_assessment_scale_id = pas.health_assessment_scale_id join healthscore_stg.hs_health_assessment_scale_result_items_master asr on asm.health_assessment_scale_id = asr.health_assessment_scale_id and asr.assessment_scale_result_item_id = par.assessment_scale_result_item_id join healthscore_stg.hs_hospital_primary_dept_master dept on asm.dept_id = dept.dept_id JOIN healthscore_stg.hs_patient_master hpm ON hpm.patient_id = pas.patient_id JOIN healthscore_stg.hs_hospital_master hhm ON hhm.hospital_id = pas.hospital_id JOIN healthscore_dw.map_patient_hospital mph ON mph.hospital_patient_cd = hpm.patient_cd AND mph.hospital_cd = hhm.hs_hospital_cd_guid JOIN healthscore_dw.fact_patient_visits fpv ON fpv.patient_key = mph.patient_key AND fpv.visit_hospital_key = mph.hospital_key AND fpv.hospital_patient_visit_id = pas.patient_visit_id",
			"where_clause": "fpv.visit_hospital_key=%i",
			"update_fields": "hospital_dept_nm=src.dept_name,assessment_result_item_seq_no=src.sequence_no,assessment_result_item_ref_range_txt=src.component_reference_range_txt,assessment_result_item_value=src.assessment_scale_result_value"
		}
	],
	"update_table_info": [
		{
			"tablename": "fact_patient_visitbills",
			"source_table": "hs_patient_visit_bill",
			"fields": "previous_visit_bill_key=src.prev_visitbill_key,previous_bill_balance_amt=src.prev_bill_balance_amt",
			"on_clause": "fact.visit_hospital_key = src.cur_visit_hospital_key AND fact.patient_visit_key= src.cur_patient_visit_key AND visit_bill_cd=src.cur_bill_cd",
			"join_query": "select curr_visit_bill.patient_visitbill_key as cur_visitbill_key,curr_visit_bill.patient_visit_key as cur_patient_visit_key,curr_visit_bill.visit_hospital_key as cur_visit_hospital_key,curr_visit_bill.visit_bill_cd as cur_bill_cd,max(prev_visit_bill.patient_visitbill_key)as prev_visitbill_key,prev_visit_bill.visit_bill_balance_amt as prev_bill_balance_amt from healthscore_dw.fact_patient_visitbills prev_visit_bill join  healthscore_dw.fact_patient_visitbills curr_visit_bill on prev_visit_bill.patient_key =curr_visit_bill.patient_key where prev_visit_bill.patient_visitbill_key < curr_visit_bill.patient_visitbill_key and  prev_visit_bill.previous_visit_bill_key is null and prev_visit_bill.previous_bill_balance_amt is null group by curr_visit_bill.patient_visitbill_key"
		}
	]
}
