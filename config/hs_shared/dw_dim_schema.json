{
	"database": "healthscore_dw",
	"insert_table_info": [
		{
			"tablename": "dim_hospital",
			"source_table": "hs_hospital_master",
			"fields": "hospital_cd,hospital_nm,hospital_addr_line1,hospital_addr_line2,hospital_addr_city_nm,hospital_addr_state_nm,hospital_addr_country_nm,hospital_addr_zipcode,hospital_phone_num,hospital_email_addr,hospital_logo,active_flg,convenience_fee,convenience_pct_flg,razorpay_account_id,patient_app_flg,created_by",
			"insert_query": "SELECT hm.hs_hospital_cd_guid,hm.hospital_nm,hm.hospital_addr_line1,hm.hospital_addr_line2,l.city, l.state, l.country,l.zipcode as hospital_addr_zipcode, hm.hospital_phone_num,hm.hospital_email_addr,hm.hospital_logo,hm.active_flg,hm.convenience_fee,hm.convenience_pct_flg,hm.razorpay_account_id, hm.patient_app_flg,created_by FROM healthscore_stg.hs_hospital_master as hm INNER JOIN healthscore_stg.hs_location_master as l WHERE hm.hospital_location_id = l.location_master_id",
			"update_fields": "hospital_nm=src.hospital_nm,hospital_addr_line1=src.hospital_addr_line1,hospital_addr_line2=src.hospital_addr_line2,hospital_addr_city_nm=src.city,hospital_addr_state_nm=src.state,hospital_addr_country_nm=src.country,hospital_phone_num=src.hospital_phone_num,hospital_email_addr=src.hospital_email_addr,hospital_logo=src.hospital_logo,active_flg=src.active_flg, convenience_fee=src.convenience_fee,convenience_pct_flg=src.convenience_pct_flg,hospital_addr_zipcode=src.hospital_addr_zipcode,razorpay_account_id=src.razorpay_account_id,patient_app_flg=src.patient_app_flg"
		},
		{
			"tablename": "dim_staff",
			"source_table": "hs_hospital_staff_master",
			"fields": "hospital_key,hospital_staff_id,hospital_staff_cd,hospital_staff_full_nm,hospital_staff_user_nm,hospital_staff_gender,hospital_staff_type_cd,hospital_staff_type_nm,hospital_staff_kmc_reg_no,email_id,mobile_number,country_cd,active_flg,created_by_user_nm,hospital_staff_dept_nm,etl_load_id",
			"insert_query": "select dim_h.hospital_key,hospital_staff_id,hospital_staff_cd,hospital_staff_full_nm,hospital_staff_user_name,hospital_staff_gender,code as hospital_staff_type_cd,description as hospital_staff_type_nm,hospital_staff_kmc_reg_no,email_id,mobile_number,country_code as country_cd,hsm.active_flg,hsm.created_by,dept.dept_name,{0} from healthscore_stg.hs_hospital_staff_master hsm join healthscore_stg.hs_hospital_staff_type_master hstm on hsm.hospital_staff_type_id = hstm.id join healthscore_stg.hs_hospital_master h on hsm.hospital_id = h.hospital_id join healthscore_dw.dim_hospital dim_h on dim_h.hospital_cd = h.hs_hospital_cd_guid join healthscore_stg.hs_hospital_primary_dept_master dept on hsm.hospital_staff_dept_id = dept.dept_id",
			"update_fields": "hospital_staff_full_nm=src.hospital_staff_full_nm,hospital_staff_user_nm=src.hospital_staff_user_name,hospital_staff_gender=src.hospital_staff_gender,hospital_staff_type_cd=src.hospital_staff_type_cd,hospital_staff_type_nm=src.hospital_staff_type_nm,hospital_staff_kmc_reg_no=src.hospital_staff_kmc_reg_no,email_id=src.email_id,mobile_number=src.mobile_number,country_cd= src.country_cd,active_flg=src.active_flg, hospital_staff_dept_nm= src.dept_name"
		},
		{
			"tablename": "dim_hospital_wards",
			"source_table": "hs_hospital_wards_master",
			"fields": "hospital_key, hospital_ward_id,hospital_ward_cd,hospital_ward_nm,hospital_ward_floor_no,hospital_ward_bedcount_no, active_flg,etl_load_id",
			"insert_query": "select dh.hospital_key,hwm.ward_id, hwm.ward_cd,hwm.ward_nm,hwm.floor_no,hwm.bedcount_no, hwm.active_flg,{0} from healthscore_stg.hs_hospital_wards_master hwm join healthscore_stg.hs_hospital_master hm on hm.hospital_id=hwm.hospital_id join healthscore_dw.dim_hospital dh on dh.hospital_cd=hm.hs_hospital_cd_guid",
			"update_fields": "hospital_key=src.hospital_key,hospital_ward_cd=src.ward_cd,hospital_ward_nm=src.ward_nm,hospital_ward_floor_no=src.floor_no,hospital_ward_bedcount_no=src.bedcount_no,active_flg=src.active_flg"
		},
		{
			"tablename": "dim_patient",
			"source_table": "hs_patient_demographics",
			"fields": "patient_unique_id,patient_nm,patient_first_nm,patient_middle_nm,patient_last_nm,patient_gender,patient_birth_dt,patient_birth_ts,patient_death_ts,patient_mother_nm,patient_father_nm,blood_group,gestational_age_in_days,birth_weight_gms,created_by_staff_key,etl_load_id",
			"insert_query": "SELECT src.patient_cd,dem.patient_nm,dem.patient_first_nm,dem.patient_middle_nm,dem.patient_last_nm,dem.gender,date(dem.birth_dt) as patient_birth_dt,dem.birth_dt as patient_birth_ts,dem.death_dt,dem.patient_mother_nm,dem.patient_father_nm,case when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%ab%' and lower(dem.blood_group_display_nm) like '%pos%' then 'AB Positive' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%ab%' and lower(dem.blood_group_display_nm) like '%neg%' then 'AB Negative' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%b%' and lower(dem.blood_group_display_nm) like '%pos%' then 'B Positive' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%b%' and lower(dem.blood_group_display_nm) like '%neg%' then 'B Negative' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%a%' and lower(dem.blood_group_display_nm) like '%pos%' then 'A Positive' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%a%' and lower(dem.blood_group_display_nm) like '%neg%' then 'A Negative' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%o%' and lower(dem.blood_group_display_nm) like '%pos%' then 'O Positive' when REPLACE(REPLACE(lower(dem.blood_group_display_nm),'positive','+ve'),'negative','-ve') like '%o%' and lower(dem.blood_group_display_nm) like '%neg%' then 'O Negative' end as blood_group,dem.gestational_age_in_days,dem.birth_weight,ds.staff_key,{0} FROM healthscore_stg.hs_patient_demographics dem JOIN healthscore_stg.hs_patient_master src ON dem.patient_id = src.patient_id JOIN healthscore_stg.hs_hospital_master hm on hm.hospital_id=src.primary_hospital_id JOIN healthscore_dw.dim_hospital dh on dh.hospital_cd=hm.hs_hospital_cd_guid JOIN healthscore_dw.dim_staff ds ON ds.hospital_staff_user_nm = dem.created_by and ds.hospital_key=dh.hospital_key WHERE LENGTH(src.patient_cd) > 0",
			"update_fields": "patient_nm=src.patient_nm,patient_first_nm=src.patient_first_nm,patient_middle_nm=src.patient_middle_nm,patient_last_nm=src.patient_last_nm,patient_gender=src.gender,patient_birth_dt=src.patient_birth_dt,patient_birth_ts=src.patient_birth_ts,patient_death_ts=src.death_dt,patient_mother_nm=src.patient_mother_nm,patient_father_nm=src.patient_father_nm,blood_group=src.blood_group,gestational_age_in_days=src.gestational_age_in_days,birth_weight_gms=src.birth_weight"
		},
		{
			"tablename": "map_patient_hospital",
			"source_table": "hs_patient_master,hs_hospital_master",
			"fields": "patient_key,hospital_key,hospital_cd,hospital_patient_cd,hospital_patient_id,hospital_registration_ts,payment_provider,patient_referred_by,default_rate_category_nm,etl_load_id",
			"insert_query": "SELECT dim_pd.patient_key,dim_dh.hospital_key,hm.hs_hospital_cd_guid,pm.patient_cd,pm.patient_id, pm.registration_ts, null, pm.referred_by,rate_category_nm,{0} FROM healthscore_stg.hs_patient_master pm JOIN healthscore_stg.hs_hospital_master hm ON pm.primary_hospital_id = hm.hospital_id JOIN  healthscore_dw.dim_hospital dim_dh ON dim_dh.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_stg.hs_patient_demographics pd on pm.patient_id = pd.patient_id join healthscore_stg.hs_rate_category_master rcm on pd.default_rate_category_id = rcm.rate_category_master_id  JOIN healthscore_dw.dim_patient dim_pd on dim_pd.patient_unique_id = pm.patient_cd WHERE length(pm.patient_cd) > 0",
			"update_fields": "patient_key = src.patient_key,hospital_key=src.hospital_key,hospital_cd=src.hs_hospital_cd_guid,hospital_patient_id=src.patient_id, hospital_registration_ts=src.registration_ts, patient_referred_by=src.referred_by"
		},
		{
			"tablename": "dim_bill_items",
			"source_table": "hs_bill_items_master",
			"fields": "hospital_key,bill_item_type,bill_item_category_id,bill_item_category_cd,bill_item_category_nm,bill_item_category_desc,bill_item_id,bill_item_cd,bill_item_nm,bill_item_amt,consulting_staff_key,total_cnt,transaction_type_cd,effective_from_ts,effective_to_ts,rate_category_nm,active_flg,etl_load_id",
			"insert_query": "SELECT dim_h.hospital_key, bill_items.bill_item_type, bill_items.bill_item_category_id,bill_items.bill_item_category_cd,bill_items.bill_item_category_nm,bill_items.bill_item_category_desc,bill_items.bill_item_id,bill_items.bill_item_cd,bill_items.bill_item_nm,bill_items.bill_item_amt,dim_s.staff_key,bill_items.total_cnt,bill_items.transaction_type_cd,bill_items.effective_from_ts,bill_items.effective_to_ts,bill_items.rate_category_nm,bill_items.active_flg,{0} FROM healthscore_dw.dim_hospital dim_h JOIN (select hm.hs_hospital_cd_guid as hospital_cd,case when inventory_flg = 1 then 'inventory_item' when bill_item_category_cd in ('PYM') then 'bill_payment' else 'bill_item' end bill_item_type, bill_item_category_id,bill_item_category_cd, bill_item_category_nm,JSON_OBJECT('bill_item_category_desc',bcm.bill_item_category_desc,'active_flg',bcm.active_flg) as bill_item_category_desc, bill_item_id,bill_item_cd,bill_item_nm,bill_item_amt,null as consulting_staff_key, transaction_type_cd,effective_from_ts, effective_to_ts,rate_category_nm, bim.active_flg, null as total_cnt from  healthscore_stg.hs_bill_items_master bim join healthscore_stg.hs_bill_category_master bcm on bim.bill_category_id = bcm.bill_item_category_id and bcm.hospital_id=bim.hospital_id join healthscore_stg.hs_rate_category_master rcm on bim.rate_category_id = rcm.rate_category_master_id join healthscore_stg.hs_hospital_master hm on bim.hospital_id = hm.hospital_id where package_flg=0 ) bill_items on dim_h.hospital_cd = bill_items.hospital_cd LEFT JOIN healthscore_dw.dim_staff dim_s on dim_s.hospital_key = dim_h.hospital_key and bill_items.consulting_staff_key = dim_s.hospital_staff_cd",
			"update_fields": "bill_item_category_nm=src.bill_item_category_nm,bill_item_category_desc=src.bill_item_category_desc,bill_item_nm=src.bill_item_nm,bill_item_amt=src.bill_item_amt,consulting_staff_key=src.staff_key,total_cnt=src.total_cnt,transaction_type_cd=src.transaction_type_cd,effective_to_ts=src.effective_to_ts,active_flg=src.active_flg"
		},
		{
			"tablename": "dim_bill_items",
			"source_table": "hs_consultant_charges_master",
			"fields": "hospital_key,bill_item_type,bill_item_category_id,bill_item_category_cd,bill_item_category_nm,bill_item_category_desc,bill_item_id,bill_item_cd,bill_item_nm,bill_item_amt,consulting_staff_key,total_cnt,transaction_type_cd,effective_from_ts,effective_to_ts,rate_category_nm,active_flg,etl_load_id",
			"insert_query": "SELECT dim_h.hospital_key, bill_items.bill_item_type, bill_items.bill_item_category_id,bill_items.bill_item_category_cd,bill_items.bill_item_category_nm,bill_items.bill_item_category_desc,bill_items.bill_item_id,bill_items.bill_item_cd,bill_items.bill_item_nm,bill_items.bill_item_amt,dim_s.staff_key,bill_items.total_cnt,bill_items.transaction_type_cd,bill_items.effective_from_ts,bill_items.effective_to_ts,bill_items.rate_category_nm,bill_items.active_flg,{0} FROM healthscore_dw.dim_hospital dim_h JOIN (select hm.hs_hospital_cd_guid as hospital_cd,'consultation' bill_item_type,bcm.bill_item_category_id,bill_item_category_cd, bill_item_category_nm, JSON_OBJECT('bill_item_category_desc',bcm.bill_item_category_desc,'consultation_type_nm',ctype.consultation_type_nm,'active_flg',ctype.active_flg) as bill_item_category_desc,ccm.con_charge_id as bill_item_id, concat(hsm.hospital_staff_cd,'-',ctype.consultation_type_nm) as bill_item_cd, concat(hsm.hospital_staff_full_nm,'-',ctype.consultation_type_nm) as bill_item_nm,ccm.default_price as bill_item_amt,hsm.hospital_staff_id as consulting_staff_key,'DR' as transaction_type_cd,effective_from_ts,effective_to_ts,rate_category_nm, ccm.active_flg, null as total_cnt from healthscore_stg.hs_consultant_charges_master ccm join healthscore_stg.hs_consultation_type_master ctype on ccm.consultation_type_id = ctype.consultation_type_id join healthscore_stg.hs_bill_category_master bcm on ctype.bill_item_category_id = bcm.bill_item_category_id and bcm.hospital_id=ccm.hospital_id join healthscore_stg.hs_rate_category_master rcm on ccm.rate_category_id = rcm.rate_category_master_id join healthscore_stg.hs_hospital_master hm on ccm.hospital_id = hm.hospital_id join healthscore_stg.hs_hospital_staff_master hsm on ccm.hospital_staff_id = hsm.hospital_staff_id and hsm.hospital_id=ccm.hospital_id) bill_items on dim_h.hospital_cd = bill_items.hospital_cd LEFT JOIN healthscore_dw.dim_staff dim_s on dim_s.hospital_key = dim_h.hospital_key and bill_items.consulting_staff_key = dim_s.hospital_staff_id",
			"update_fields": "bill_item_category_nm=src.bill_item_category_nm,bill_item_category_desc=src.bill_item_category_desc,bill_item_nm=src.bill_item_nm,bill_item_amt=src.bill_item_amt,consulting_staff_key=src.staff_key,total_cnt=src.total_cnt,transaction_type_cd=src.transaction_type_cd,effective_to_ts=src.effective_to_ts,active_flg=src.active_flg"
		},
		{
			"tablename": "dim_bill_items",
			"source_table": "hs_hospital_package_master",
			"fields": "hospital_key,bill_item_type,bill_item_category_id,bill_item_category_cd,bill_item_category_nm,bill_item_category_desc,bill_item_id,bill_item_cd,bill_item_nm,bill_item_amt,consulting_staff_key,total_cnt,transaction_type_cd,effective_from_ts,effective_to_ts,rate_category_nm,active_flg,pkg_effective_from_ts,pkg_effective_to_ts,renewal_item_flg,display_seq_no,etl_load_id",
			"insert_query": "SELECT dh.hospital_key, CASE WHEN pm.patient_app_subscription_flg = 1 THEN 'bill_package_app_subscription' ELSE 'bill_package' END AS bill_item_type, bim.bill_item_id AS bill_item_category_id, bim.bill_item_cd AS bill_item_category_cd, bim.bill_item_nm AS bill_item_category_nm, JSON_OBJECT('validity_no_days', pm.no_of_days, 'multi_visit_flg', pm.multi_visit_flg, 'effective_from_ts', bim.effective_from_ts, 'effective_to_ts', bim.effective_to_ts, 'pkg_amt', bim.bill_item_amt, 'patient_app_subscription_flg', pm.patient_app_subscription_flg, 'active_flg', bim.active_flg, 'bill_item_category_desc', bcm.bill_item_category_desc, 'renewal_reminder_days', pm.renewal_reminder_days, 'package_desc', pm.package_desc, 'renewal_amt', pm.renewal_amt) AS bill_item_category_desc, bim.bill_item_id, bim.bill_item_cd, bim.bill_item_nm, bim.bill_item_amt, NULL AS staff_key, NULL AS total_count, 'DR' AS transaction_type_cd, bim.effective_from_ts, bim.effective_to_ts, 'Default' AS rate_category_nm, bim.active_flg, bim.effective_from_ts AS pkg_effective_from_ts, bim.effective_to_ts AS pkg_effective_to_ts, bim.renewal_item_flg, NULL AS display_seq_no,{0} FROM healthscore_stg.hs_bill_items_master bim JOIN healthscore_stg.hs_hospital_master hm ON hm.hospital_id = bim.hospital_id JOIN healthscore_dw.dim_hospital dh ON dh.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_stg.hs_hospital_package_master pm ON pm.bill_item_cd = bim.bill_item_cd and pm.hospital_id=hm.hospital_id LEFT JOIN healthscore_stg.hs_hospital_package_mapped_items_master pmim ON pm.package_master_id = pmim.package_master_id LEFT JOIN healthscore_stg.hs_bill_category_master bcm ON bim.bill_category_id = bcm.bill_item_category_id and pm.hospital_id=bcm.hospital_id WHERE package_mapped_item_id IS NULL and bim.effective_to_ts is null UNION ALL SELECT  dim_h.hospital_key, CASE WHEN pm.patient_app_subscription_flg = 1 THEN 'bill_package_app_subscription' ELSE 'bill_package' END bill_item_type, bim_pkg.bill_item_id AS bill_item_category_id, pm.bill_item_cd AS bill_item_category_cd, bim_pkg.bill_item_nm AS bill_item_category_nm, JSON_OBJECT('validity_no_days', pm.no_of_days, 'multi_visit_flg', pm.multi_visit_flg, 'effective_from_ts', bim_pkg.effective_from_ts, 'effective_to_ts', bim_pkg.effective_to_ts, 'pkg_amt', bim_pkg.bill_item_amt, 'patient_app_subscription_flg', pm.patient_app_subscription_flg, 'active_flg', bim_pkg.active_flg, 'bill_item_category_desc', bcm.bill_item_category_desc, 'renewal_reminder_days', pm.renewal_reminder_days, 'package_desc', pm.package_desc, 'renewal_amt', pm.renewal_amt) AS bill_item_category_desc, dim_b.bill_item_id, dim_b.bill_item_cd, dim_b.bill_item_nm, dim_b.bill_item_amt, NULL AS staff_key, pmim.total_count, 'DR' AS transaction_type_cd, COALESCE(dim_b.effective_from_ts, bim_pkg.effective_from_ts) AS effective_from_ts, dim_b.effective_to_ts, COALESCE(dim_b.rate_category_nm, 'Default') AS rate_category_nm, pmim.active_flg, bim_pkg.effective_from_ts AS pkg_effective_from_ts, bim_pkg.effective_to_ts AS pkg_effective_to_ts, dim_b.renewal_item_flg, dim_b.display_seq_no,{0} FROM healthscore_stg.hs_hospital_package_master pm JOIN healthscore_stg.hs_hospital_master hm ON pm.hospital_id = hm.hospital_id JOIN healthscore_dw.dim_hospital dim_h ON dim_h.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_stg.hs_bill_items_master bim_pkg ON pm.bill_item_cd = bim_pkg.bill_item_cd AND IFNULL(bim_pkg.effective_to_ts, '9999-12-31') = '9999-12-31' and pm.hospital_id=bim_pkg.hospital_id JOIN healthscore_stg.hs_hospital_package_mapped_items_master pmim ON pm.package_master_id = pmim.package_master_id JOIN healthscore_dw.dim_bill_items dim_b ON pmim.bill_item_cd = dim_b.bill_item_cd AND pmim.created_ts BETWEEN dim_b.effective_from_ts AND IFNULL(dim_b.effective_to_ts, '9999-12-31') AND dim_b.rate_category_nm = 'Default' AND dim_b.bill_item_type = 'bill_item' and dim_h.hospital_key=dim_b.hospital_key LEFT JOIN healthscore_stg.hs_bill_category_master bcm ON bim_pkg.bill_category_id = bcm.bill_item_category_id and pm.hospital_id=bcm.hospital_id UNION ALL SELECT  dim_h.hospital_key, CASE WHEN pm.patient_app_subscription_flg = 1 THEN 'bill_package_app_subscription' ELSE 'bill_package' END bill_item_type, bim_pkg.bill_item_id AS bill_item_category_id, pm.bill_item_cd AS bill_item_category_cd, bim_pkg.bill_item_nm AS bill_item_category_nm, JSON_OBJECT('validity_no_days', pm.no_of_days, 'multi_visit_flg', pm.multi_visit_flg, 'effective_from_ts', bim_pkg.effective_from_ts, 'effective_to_ts', bim_pkg.effective_to_ts, 'pkg_amt', bim_pkg.bill_item_amt, 'patient_app_subscription_flg', pm.patient_app_subscription_flg, 'active_flg', bim_pkg.active_flg, 'bill_item_category_desc', bcm.bill_item_category_desc, 'renewal_reminder_days', pm.renewal_reminder_days, 'package_desc', pm.package_desc, 'renewal_amt', pm.renewal_amt) AS bill_item_category_desc, COALESCE(dim_b.bill_item_id, ctype.consultation_type_id) AS bill_item_id, CASE WHEN dim_s.hospital_staff_cd IS NULL THEN ctype.consultation_type_nm ELSE CONCAT(dim_s.hospital_staff_cd, '-', ctype.consultation_type_nm) END AS bill_item_cd, CASE WHEN dim_s.hospital_staff_cd IS NULL THEN ctype.consultation_type_nm ELSE CONCAT(dim_s.hospital_staff_full_nm, '-', ctype.consultation_type_nm) END bill_item_nm, COALESCE(dim_b.bill_item_amt, 0) AS bill_item_amt, dim_s.staff_key, pmim.total_count, 'DR' AS transaction_type_cd, COALESCE(dim_b.effective_from_ts, pmim.created_ts) AS effective_from_ts, dim_b.effective_to_ts, COALESCE(dim_b.rate_category_nm, rcm.rate_category_nm) AS rate_category_nm, pmim.active_flg, bim_pkg.effective_from_ts AS pkg_effective_from_ts, bim_pkg.effective_to_ts AS pkg_effective_to_ts, dim_b.renewal_item_flg, dim_b.display_seq_no,{0} FROM healthscore_stg.hs_hospital_package_master pm JOIN healthscore_stg.hs_hospital_package_mapped_items_master pmim ON pm.package_master_id = pmim.package_master_id JOIN healthscore_stg.hs_hospital_master hm ON pm.hospital_id = hm.hospital_id JOIN healthscore_dw.dim_hospital dim_h ON dim_h.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_stg.hs_consultation_type_master ctype ON pmim.consultation_type_id = ctype.consultation_type_id AND ctype.hospital_id = hm.hospital_id JOIN healthscore_dw.dim_staff dim_s ON pmim.hospital_staff_id = dim_s.hospital_staff_id and dim_h.hospital_key=dim_s.hospital_key JOIN healthscore_dw.dim_bill_items dim_b ON (dim_b.consulting_staff_key = dim_s.staff_key AND JSON_EXTRACT(dim_b.bill_item_category_desc, '$.consultation_type_nm') = ctype.consultation_type_nm) AND pmim.created_ts BETWEEN dim_b.effective_from_ts AND IFNULL(dim_b.effective_to_ts, '9999-12-31') AND dim_b.rate_category_nm = 'Default' AND dim_b.bill_item_type = 'consultation' AND dim_b.hospital_key = dim_h.hospital_key JOIN healthscore_stg.hs_bill_items_master bim_pkg ON pm.bill_item_cd = bim_pkg.bill_item_cd AND IFNULL(bim_pkg.effective_to_ts, '9999-12-31') = '9999-12-31' and pm.hospital_id=bim_pkg.hospital_id LEFT JOIN healthscore_stg.hs_bill_category_master bcm ON bim_pkg.bill_category_id = bcm.bill_item_category_id and bcm.hospital_id=bim_pkg.hospital_id JOIN healthscore_stg.hs_rate_category_master rcm ON bim_pkg.rate_category_id = rcm.rate_category_master_id UNION ALL SELECT  dim_h.hospital_key, CASE WHEN pm.patient_app_subscription_flg = 1 THEN 'bill_package_app_subscription' ELSE 'bill_package' END bill_item_type, bim_pkg.bill_item_id AS bill_item_category_id, pm.bill_item_cd AS bill_item_category_cd, bim_pkg.bill_item_nm AS bill_item_category_nm, JSON_OBJECT('validity_no_days', pm.no_of_days, 'multi_visit_flg', pm.multi_visit_flg, 'effective_from_ts', bim_pkg.effective_from_ts, 'effective_to_ts', bim_pkg.effective_to_ts, 'pkg_amt', bim_pkg.bill_item_amt, 'patient_app_subscription_flg', pm.patient_app_subscription_flg, 'active_flg', bim_pkg.active_flg, 'bill_item_category_desc', bcm.bill_item_category_desc, 'renewal_reminder_days', pm.renewal_reminder_days, 'package_desc', pm.package_desc, 'renewal_amt', pm.renewal_amt) AS bill_item_category_desc, dim_b.bill_item_id, dim_b.bill_item_cd, dim_b.bill_item_nm, dim_b.bill_item_amt, NULL AS staff_key, pmim.total_count, 'DR' AS transaction_type_cd, dim_b.effective_from_ts, dim_b.effective_to_ts, dim_b.rate_category_nm, pmim.active_flg, bim_pkg.effective_from_ts AS pkg_effective_from_ts, bim_pkg.effective_to_ts AS pkg_effective_to_ts, dim_b.renewal_item_flg, dim_b.display_seq_no,{0} FROM healthscore_stg.hs_hospital_package_master pm JOIN healthscore_stg.hs_hospital_package_mapped_items_master pmim ON pm.package_master_id = pmim.package_master_id JOIN healthscore_stg.hs_hospital_master hm ON pm.hospital_id = hm.hospital_id JOIN healthscore_stg.hs_product_master prom ON pmim.product_master_id = prom.product_master_id   JOIN healthscore_dw.dim_hospital dim_h ON   dim_h.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_dw.dim_bill_items dim_b ON prom.product_cd = dim_b.bill_item_cd AND pmim.created_ts BETWEEN dim_b.effective_from_ts AND IFNULL(dim_b.effective_to_ts, '9999-12-31') AND dim_b.rate_category_nm = 'Default' AND dim_b.bill_item_type = 'inventory_item' and dim_b.hospital_key = dim_h.hospital_key JOIN healthscore_stg.hs_bill_items_master bim_pkg ON pm.bill_item_cd = bim_pkg.bill_item_cd AND IFNULL(bim_pkg.effective_to_ts, '9999-12-31') = '9999-12-31' and bim_pkg.hospital_id=pm.hospital_id LEFT JOIN healthscore_stg.hs_bill_category_master bcm ON bim_pkg.bill_category_id = bcm.bill_item_category_id and bcm.hospital_id=pm.hospital_id",
			"update_fields": "bill_item_category_nm=src.bill_item_category_nm,bill_item_nm=src.bill_item_nm,bill_item_amt=src.bill_item_amt,consulting_staff_key=src.staff_key,transaction_type_cd=src.transaction_type_cd,effective_to_ts=src.effective_to_ts,pkg_effective_to_ts=src.pkg_effective_to_ts,active_flg=src.active_flg"
		},
		{
			"tablename": "dim_bill_items",
			"source_table": "hs_hospital_package_master-package update",
			"fields": "hospital_key,bill_item_type,bill_item_category_id,bill_item_category_cd,bill_item_category_nm,bill_item_category_desc,bill_item_id,bill_item_cd,bill_item_nm,bill_item_amt,consulting_staff_key,total_cnt,transaction_type_cd,effective_from_ts,effective_to_ts,rate_category_nm,active_flg,pkg_effective_from_ts,pkg_effective_to_ts,renewal_item_flg,display_seq_no,etl_load_id",
			"insert_query": "SELECT  dbi.hospital_key, dbi.bill_item_type, dbi.bill_item_category_id, dbi.bill_item_category_cd, bim.bill_item_nm AS bill_item_category_nm, JSON_OBJECT('validity_no_days', pm.no_of_days, 'multi_visit_flg', pm.multi_visit_flg, 'effective_from_ts', bim.effective_from_ts, 'effective_to_ts', bim.effective_to_ts, 'pkg_amt', bim.bill_item_amt, 'patient_app_subscription_flg', pm.patient_app_subscription_flg, 'active_flg', bim.active_flg, 'bill_item_category_desc', bcm.bill_item_category_desc, 'renewal_reminder_days', pm.renewal_reminder_days, 'package_desc', pm.package_desc, 'renewal_amt', pm.renewal_amt) AS bill_item_category_desc, dbi.bill_item_id, dbi.bill_item_cd, dbi.bill_item_nm, dbi.bill_item_amt, dbi.consulting_staff_key, dbi.total_cnt AS total_count, dbi.transaction_type_cd, dbi.effective_from_ts, dbi.effective_to_ts, dbi.rate_category_nm, bim.active_flg, bim.effective_from_ts AS pkg_effective_from_ts, bim.effective_to_ts AS pkg_effective_to_ts, bim.renewal_item_flg, dbi.display_seq_no,{0} FROM healthscore_stg.hs_bill_items_master bim JOIN healthscore_stg.hs_hospital_master hm ON hm.hospital_id = bim.hospital_id JOIN healthscore_dw.dim_hospital dh ON dh.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_stg.hs_hospital_package_master pm ON pm.bill_item_cd = bim.bill_item_cd and pm.hospital_id=bim.hospital_id JOIN (SELECT DISTINCT bill_item_category_cd, hospital_key, bill_item_type, bill_item_category_id, bill_item_id, bill_item_cd, bill_item_nm, bill_item_amt, consulting_staff_key, total_cnt, transaction_type_cd, effective_from_ts, effective_to_ts, rate_category_nm, display_seq_no FROM healthscore_dw.dim_bill_items) dbi ON dbi.bill_item_category_cd = bim.bill_item_cd AND dh.hospital_key = dbi.hospital_key AND dbi.rate_category_nm = 'Default' AND (dbi.bill_item_type = 'bill_package' OR dbi.bill_item_type = 'bill_package_app_subscription') LEFT JOIN healthscore_stg.hs_bill_category_master bcm ON bim.bill_category_id = bcm.bill_item_category_id and bcm.hospital_id=bim.hospital_id",
			"update_fields": "bill_item_category_nm=src.bill_item_category_nm,bill_item_category_desc=src.bill_item_category_desc,bill_item_nm=src.bill_item_nm,bill_item_amt=src.bill_item_amt,consulting_staff_key=src.consulting_staff_key,total_cnt=src.total_count,transaction_type_cd=src.transaction_type_cd,effective_to_ts=src.effective_to_ts,active_flg=src.active_flg,renewal_item_flg=src.renewal_item_flg,display_seq_no=src.display_seq_no,pkg_effective_to_ts=src.pkg_effective_to_ts"
		},
		{
			"tablename": "dim_bill_items",
			"source_table": "hs_hospital_package_master-package items update",
			"fields": "hospital_key,bill_item_type,bill_item_category_id,bill_item_category_cd,bill_item_category_nm,bill_item_category_desc,bill_item_id,bill_item_cd,bill_item_nm,bill_item_amt,consulting_staff_key,total_cnt,transaction_type_cd,effective_from_ts,effective_to_ts,rate_category_nm,active_flg,pkg_effective_from_ts,pkg_effective_to_ts,renewal_item_flg,display_seq_no,etl_load_id",
			"insert_query": "SELECT dim_h.hospital_key, CASE WHEN pm.patient_app_subscription_flg = 1 THEN 'bill_package_app_subscription' ELSE 'bill_package' END bill_item_type, dim_p.bill_item_category_id, pm.bill_item_cd AS bill_item_category_cd, dim_p.bill_item_category_nm, dim_p.bill_item_category_desc, dim_b.bill_item_id, dim_b.bill_item_cd, dim_b.bill_item_nm, dim_b.bill_item_amt, NULL AS consulting_staff_key, pmim.total_count, 'DR' AS transaction_type_cd, dim_b.effective_from_ts, dim_b.effective_to_ts, dim_p.rate_category_nm, pmim.active_flg, dim_p.pkg_effective_from_ts, dim_p.pkg_effective_to_ts, dim_p.renewal_item_flg, dim_p.display_seq_no,{0} FROM healthscore_stg.hs_hospital_package_master pm JOIN healthscore_stg.hs_hospital_package_mapped_items_master pmim ON pm.package_master_id = pmim.package_master_id JOIN healthscore_stg.hs_hospital_master hm ON pm.hospital_id = hm.hospital_id JOIN healthscore_dw.dim_hospital dim_h ON dim_h.hospital_cd = hm.hs_hospital_cd_guid JOIN healthscore_dw.dim_bill_items dim_b ON pmim.bill_item_cd = dim_b.bill_item_cd AND pmim.created_ts BETWEEN dim_b.effective_from_ts AND IFNULL(dim_b.effective_to_ts, '9999-12-31') AND dim_b.rate_category_nm = 'Default' AND dim_b.hospital_key=dim_h.hospital_key AND dim_b.bill_item_type IN ('bill_item') JOIN (select  distinct bill_item_category_cd, bill_item_category_nm,rate_category_nm,bill_item_category_desc,bill_item_category_id,pkg_effective_from_ts,pkg_effective_to_ts,renewal_item_flg,display_seq_no,hospital_key  from healthscore_dw.dim_bill_items  where bill_item_type ='bill_package_app_subscription' or bill_item_type='bill_package')dim_p on pm.bill_item_cd = dim_p.bill_item_category_cd AND dim_p.rate_category_nm =  dim_b.rate_category_nm and dim_p.pkg_effective_to_ts is null AND dim_p.hospital_key=dim_h.hospital_key",
			"update_fields": "effective_to_ts=src.effective_to_ts,active_flg=src.active_flg,pkg_effective_to_ts=src.pkg_effective_to_ts,total_cnt=src.total_count"
		}
	],
	"update_table_info": [
		{
			"tablename": "dim_patient",
			"source_table": "hs_patient_secondary_attribute_relation",
			"fields": "patient_occupation=src.occupation,patient_marital_status=src.marital_status,patient_religion=src.religion,patient_spouse_occupation=src.spouse_occupation",
			"on_clause": "dim.patient_unique_id = src.patient_cd AND dim.patient_unique_id_type='hospital_patient_cd'",
			"join_query": "SELECT r.religion,r.occupation,r.marital_status,r.spouse_occupation,pm.patient_cd FROM (SELECT sr.patient_id,  max(case when attribute_name = 'Religion' then description else null end) as religion,max(case when attribute_name = 'Occupation' then description else null end) as occupation,max(case when attribute_name = 'Marital Status' then description else null end) as marital_status,max(case when attribute_name = 'Spouse Occupation' then description else null end) as spouse_occupation FROM healthscore_stg.hs_patient_secondary_attribute_relation AS sr INNER JOIN healthscore_stg.hs_patient_secondary_attribute_master AS sm ON sr.secondry_attribute_master_id = sm.patient_secondary_attribute_id and sr.description is not null WHERE sm.attribute_name in ( 'Religion','Occupation','Marital Status','Spouse Occupation') group by sr.patient_id ) r join healthscore_stg.hs_patient_master pm on r.patient_id = pm.patient_id"
		},
		{
			"tablename": "dim_patient",
			"source_table": "hs_patient_contact_details",
			"fields": "dim.contact_email_id = src.email_id,dim.contact_addr_line1=src.patient_addr_line1,dim.contact_addr_line2=src.patient_addr_line2,dim.contact_addr_city_nm=src.city,dim.contact_addr_state_nm=src.state,dim.contact_addr_country_nm=src.country,dim.contact_addr_zipcode=src.contact_addr_zipcode,dim.contact_home_phone_num=src.patient_home_phone_num,dim.contact_mobile_phone_num=src.patient_mobile_phone_num,dim.patient_alternate_phone_num=src.patient_alternate_phone_num,dim.patient_emerg_contact_nm=src.patient_emerg_contact_name,dim.patient_emerg_contact_num=src.patient_emerg_contact_num,dim.patient_relation=src.patient_relation",
			"on_clause": "dim.patient_unique_id = src.patient_cd AND dim.patient_unique_id_type='hospital_patient_cd'",
			"join_query": "select pm.patient_cd, con.email_id,con.patient_addr_line1,con.patient_addr_line2,l.city, l.state, l.country,l.zipcode as contact_addr_zipcode, con.patient_home_phone_num,con.patient_mobile_phone_num,con.patient_alternate_phone_num,con.patient_emerg_contact_name,con.patient_emerg_contact_num,con.patient_relation from healthscore_stg.hs_patient_contact_details con join healthscore_stg.hs_patient_master pm  on con.patient_id = pm.patient_id LEFT JOIN healthscore_stg.hs_location_master as l ON con.patient_location_id = l.location_master_id WHERE length(pm.patient_cd) > 0"
		}
	]
}
